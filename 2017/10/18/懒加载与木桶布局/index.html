<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Xie Hao"><meta name="description" conauthortent="个人博客"><link rel="alternative" href="/atom.xml" title="xiehao.online" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><title>懒加载与木桶布局 - xiehao.online</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0;"><header class="head"><h1 class="head-title u-fl"><a href="/">xiehao.online</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Catalogue /（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2017-10-18T07:45:17.000Z">October 18, 2017</time><h1 class="post__title"><a href="/2017/10/18/懒加载与木桶布局/">懒加载与木桶布局</a></h1><div class="post__main echo"><h2 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h2><p>假如一个图片网站有成千上万的图片，如果用户一打开页面，所有的图片都去同时去加载，浏览器就会卡主等到图片全部加载完成，如果用户发现这些图片并不是他想要的那么就会白白浪费很多流量，这样的体验并不好，所以通过检测图片是否出现在用户的视窗中，如果出现了就去加载，如果没出现就不去加载，这种方法就叫做懒加载。</p>
<h3 id="懒加载的思路"><a href="#懒加载的思路" class="headerlink" title="懒加载的思路"></a>懒加载的思路</h3><p>1.我们将页面上所有<img>标签src属性中的图片地址，放在一个我们自定义的属性中，比如：</p>
<pre><code>&lt;img src=&quot;&quot; datasrc=&quot;xxx.png&quot;&gt;
</code></pre><p>这样页面打开后图片也不会加载，自定义属性的名字可以随便起，只要不和已有的属性名重复就行；<br>2.获取整个窗口高度和滚动的距离，img标签的位置。如果img标签的位置小于窗口高度加滚动的距离，那么该img标签就出现在了用户的视窗中；<br>3.检查出现用户视窗中的img标签的图片否加载过，如果没有那么就加载该图片。</p>
<h3 id="实现："><a href="#实现：" class="headerlink" title="实现："></a>实现：</h3><p>1.图片示例:</p>
<pre><code>&lt;img src=&quot;&quot; alt=&quot;&quot; datasrc=&quot;1.jpg&quot;&gt;
</code></pre><p>2.写一个判断img标签是否出现在视窗中的函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkImg</span>(<span class="params">value</span>)</span>&#123; <span class="comment">//参数value表示我们传入的img标签</span></div><div class="line">    <span class="keyword">var</span> scrollLength = $(<span class="built_in">window</span>).scrollTop(), <span class="comment">//scrollLength代表滚动的距离</span></div><div class="line">    wimdowHeight = $(<span class="built_in">window</span>).height(), <span class="comment">//wimdowHeight代表窗口高度</span></div><div class="line">    imgOffset = value.offset().top; <span class="comment">//imgOffset代表img标签的位置</span></div><div class="line">    <span class="keyword">if</span>(imgOffset &lt;  (scrollLength+wimdowHeight))&#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//表示该img标签已出现在视窗中</span></div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">//表示该img标签没有出现在视窗中</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3.写一个判断img标签是否加载过的函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadImg</span>(<span class="params">value</span>)</span>&#123;</div><div class="line">    value.attr(<span class="string">'src'</span>,value.attr(<span class="string">'data-src'</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>只需要判断传入的这个img标签的src中的地址，是不是和自定义属性data-src相等，就可以判断出该图片是否加载</p>
<p>4.写一个加载图片的函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadImg</span>(<span class="params">value</span>)</span>&#123;</div><div class="line">    value.attr(<span class="string">'src'</span>,value.attr(<span class="string">'data-src'</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将传入的img标签的src中的图片地址换成datasrc中的地址即可。</p>
<p>5.写一个函数，遍历所有的img标签，当img标签满足出现在视窗且没有加载过的条件时，加载该img标签<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    $(<span class="string">'.wrap img'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(checkImg($(<span class="keyword">this</span>)) &amp;&amp; !isLoad($(<span class="keyword">this</span>)))&#123;</div><div class="line">            loadImg($(<span class="keyword">this</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>6.给window绑定scroll事件，我们需要在用户打开页面时就执行一次函数render，如果不先执行一次，用户打开页面没有滚动的时候，就一张图片都看不到<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    render();</div><div class="line">    <span class="keyword">var</span> lock;</div><div class="line">    $(<span class="built_in">window</span>).on(<span class="string">'scroll'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(lock)&#123;</div><div class="line">            clearTimeout(lock);</div><div class="line">        &#125;</div><div class="line">        lock = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            render();</div><div class="line">        &#125;,<span class="number">500</span>)</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>setTimeout是为了性能考虑，因为一般滚动一次会触发好几次scroll事件，所以这样写让最后一次事件再去执行render()，也就是用户连续滚动停下来的500毫秒后去加载图片。</p>
<h2 id="木桶布局"><a href="#木桶布局" class="headerlink" title="木桶布局"></a>木桶布局</h2><p>实现CSS：<br>    <figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">*&#123;</div><div class="line">	<span class="attribute">margin</span>: <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="selector-tag">body</span>&#123;</div><div class="line">	<span class="attribute">padding</span>: <span class="number">50px</span> <span class="number">0</span>;</div><div class="line">	<span class="attribute">overflow-x</span>: hidden;</div><div class="line">&#125;</div><div class="line"><span class="selector-class">.wrap</span>&#123;</div><div class="line">	<span class="attribute">display</span>: flex;</div><div class="line">	<span class="attribute">flex-wrap</span>: wrap;</div><div class="line">&#125;</div><div class="line"><span class="selector-class">.wrap</span> <span class="selector-tag">img</span>&#123;</div><div class="line">	<span class="attribute">margin</span>: <span class="number">3px</span>;</div><div class="line">	<span class="attribute">padding</span>: <span class="number">5px</span>;</div><div class="line">	<span class="attribute">height</span>: <span class="number">200px</span>;</div><div class="line">	<span class="attribute">background</span>: <span class="number">#ccc</span>;</div><div class="line">	<span class="attribute">flex-grow</span>: <span class="number">1</span>;</div><div class="line">	<span class="attribute">object-fit</span>: cover;</div><div class="line">	<span class="attribute">transition</span>: .<span class="number">3s</span>;</div><div class="line">&#125;</div><div class="line"><span class="selector-class">.wrap</span><span class="selector-pseudo">:after</span>&#123;</div><div class="line">	<span class="attribute">display</span>: block;</div><div class="line">	<span class="attribute">content</span>: <span class="string">''</span>;</div><div class="line">	<span class="attribute">flex-grow</span>: <span class="number">9999</span>;</div><div class="line">&#125;</div><div class="line"><span class="selector-class">.wrap</span> <span class="selector-tag">img</span><span class="selector-pseudo">:hover</span>&#123;</div><div class="line">	<span class="attribute">transform</span>: <span class="built_in">scale</span>(1.2);</div><div class="line">	<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">20px</span> <span class="number">#fff</span>;</div><div class="line">	<span class="attribute">z-index</span>: <span class="number">9999</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://coding.net/u/goonxh/p/lazyload/git/blob/master/index.html" target="_blank" rel="external">代码地址</a><br><a href="http://goonxh.coding.me/lazyload/" target="_blank" rel="external">预览地址</a></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/js/">js</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/css/">css</a></li></ul></footer></article><div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC8yOTc2MS82MzI3"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2018 Xie Hao</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>